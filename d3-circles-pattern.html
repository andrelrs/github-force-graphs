<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

.d3-tip {
  line-height: 1;
  font-weight: bold;
  font-size: 10px;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
  pointer-events: none;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  position: absolute;
  pointer-events: none;
}

.d3-tip span {
  color: #ff00c7;
}
</style>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"

<!-- Latest compiled and minified JavaScript -->
<script src="jquery-1.11.3.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
</head>
<body>
	<div class="page-header">
	  <h1>Github Graphs <small>beta</small></h1>
	</div>
	<form id= "githubform" class="form-inline">
	  <div class="form-group">
	    <label for="username">User</label>
	    <input type="text" class="form-control" id="username" placeholder="google">
	  </div>
	  <div class="form-group">
	    <label for="repo">Repository</label>
	    <input type="text" class="form-control" id="repo" placeholder="material-design-lite">
	  </div>
    <div class="btn-group" data-toggle="buttons">
      <label class="btn btn-primary active">
        <input type="radio" name="options" id="option1" autocomplete="off" checked> Repository
      </label>
      <label class="btn btn-primary">
        <input type="radio" name="options" id="option2" autocomplete="off"> Followers
      </label>
    </div>
	  <button type="submit" id="submit-button" data-loading-text="Loading..." class="btn btn-default">Graph it!</button>
	</form>
	<div id="graph"></div>
<script>
var width = 1024,
    height = 768;

var max_node_size = 64;
var min_node_size = 32;

function endsWith(str, suffix) {
    return str.indexOf(suffix, str.length - suffix.length) !== -1;
}



d3.select("#githubform").on("submit", function() {
	$('#graph').empty();
  $('#submit-button').button('loading');
	d3.event.preventDefault();
	var force = d3.layout.force()
	    .charge(-600)
	    .linkDistance(30)
	    .size([width, height]);

	var svg = d3.select("#graph").append("svg")
	    .attr("width", width)
	    .attr("height", height);

		var tip = d3.tip()
		    .attr('class', 'd3-tip')
		    .offset([-3, 0])
		    .html(function (d) {
			if (d.filename != undefined){
				return '<span>file: </span>' + d.filename ;
			}else{
				return '<span>user: </span>' + d.login ;
			}

		})
		svg.call(tip);

    var url = "";
    if ($('#option1').is(':checked')){
      url = "http://localhost:3000/repo-graph?user=" + $('#username').val() + "&repo=" +  $('#repo').val();
    }else{
      url = "http://localhost:3000/followers-graph?user=" + $('#username').val();
    }

	  d3.json(url, function(error, graph) {
      $('#submit-button').button('reset');
	  if (error) throw error;

	  force
	      .nodes(graph.nodes)
	      .links(graph.links)
		  .gravity(0.5)
	      .start();

		svg.append('defs').attr("id", "imgdefs").selectAll('pattern')
		    .data(graph.nodes)
		    .enter().append("pattern")
			                        .attr("id", function(d){ return (d.login)?d.login:d.filename; })
			                        .attr("height", 1)
			                        .attr("width", 1)
			                        .attr("x", "0")
			                        .attr("y", "0")
									.append("image")
									     .attr("x", 0)
									     .attr("y", 0)
									     .attr("height", function(d){
										 		if (d.login != undefined){
													return Math.log(d.weight + 10)*10;
												}else{
													return Math.log(d.weight + 10)*8;
												}
											})
									     .attr("width", function(d)	{
											 		if (d.login != undefined){
														return Math.log(d.weight+ 10)*10;
													}else{
														return Math.log(d.weight+ 10)*8 ;
													}
												})
									     .attr("xlink:href", function(d){
														if (d.avatar_url){
															return d.avatar_url;
														}else{
															if (endsWith(d.filename, "html")){
																return "file-icons/PNG/html.png";
															}else if (endsWith(d.filename, "png")){
																return "file-icons/PNG/png.png";
															}else if (endsWith(d.filename, "jpg")){
																return "file-icons/PNG/jpg.png";
															}else if (endsWith(d.filename, "js")){
																return "file-icons/PNG/js.png";
															}else if (endsWith(d.filename, "css") || endsWith(d.filename, "scss")){
																return "file-icons/PNG/css.png";
															}else if (endsWith(d.filename, "java")){
																	return "file-icons/PNG/java.png";
															}else{
																return "file-icons/PNG/txt.png";
															}
														}
										              });
		     /* .attr('id', function(d){ return d.id; })
		      .attr('viewBox', '0 0 ' + s + ' ' + s)
		      .attr('refX', s)
		      .attr('refY', s / 2)
		      .attr('orient', 'auto')
		      .attr('markerWidth', s / 5)
		      .attr('markerHeight', s / 5)
		      .append('polyline')
		        .attr('points', '0,0 ' +
		                        s + ',' + s / 2 + ' ' +
		                        '0,' + s + ' ' +
		                        s / 5 + ',' + s / 2)
		        .attr('fill', function(d){ return d.fill; })*/
		      ;

	  var link = svg.selectAll(".link")
	      .data(graph.links)
	    .enter().append("line")
	      .attr("class", "link")
	      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

	  var node = svg.selectAll(".node")
	      .data(graph.nodes)
	      .enter().append("g")
	      .attr("class", "node")
	      .on('mouseover', tip.show)
        .on('mouseout', tip.hide)


	  	  node.on( 'click', function (d) {
          if (d.login != undefined){
            d3.select("h1").html("<a href='" + d.html_url + "' >"  + d.login + " <small>Github profile ⇢</small> "+ "</a>");
          }else{
            d3.select("h1").html("<a href='" + d.raw_url + "' >"  + d.filename + " <small>raw ⇢</small>"+ "</a>");
          }

	          //d3.select("h2").html(d.login);
	          d3.select("h3").html ("View: " + "<a href='" + d.raw_url + "' >"  + d.filename + " web page ⇢"+ "</a>" );
	       })

	  	  var file_node = node.filter(function(d){
			  return (d.filename != undefined);
			});

		  file_node.append('svg:rect')
		  .attr("x", function(d){ return -(Math.log(d.weight+ 10)*8)/2 })
		  .attr("y", function(d){ return -(Math.log(d.weight+ 10)*8)/2 })
			  .attr('width', function(d){ return Math.log(d.weight+ 10)*8})
			  .attr('height', function(d){ return Math.log(d.weight+ 10)*8 }).style("fill", function(d) { return "url(#" + d.filename + ")"; }).style("stroke-width","0")

		  var user_node = node.filter(function(d){
				  return (d.login != undefined);
				});

		  user_node.append("circle")
			      //.attr("class", "node")
			      .attr("r", function(d){ return Math.log(d.weight+ 10)*5 })
			      .style("fill", function(d) { return (d.login)?"url(#" + d.login + ")":"url(#" + d.filename + ")"; })


	  node.append("title")
	      .text(function(d) { return d.login?d.login:d.filename; });
	  node.call(force.drag);

	  force.on("tick", function() {
	    link.attr("x1", function(d) { return d.source.x; })
	        .attr("y1", function(d) { return d.source.y; })
	        .attr("x2", function(d) { return d.target.x; })
	        .attr("y2", function(d) { return d.target.y; });

	    //node.attr("cx", function(d) { return d.x; })
	    //    .attr("cy", function(d) { return d.y; });
	    node
	        .attr("transform", function(d) {
			    return "translate(" + d.x + "," + d.y + ")"; });
	  });
	});

});

//$('.form-inline').on('submit', renderGraph);
</script>
